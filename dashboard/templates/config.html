{% extends "base.html" %}
{% block title %}Configurações — Nero{% endblock %}

{% block content %}
<!-- Container principal para a página de configurações. -->
<div class="config-container"
    style="max-width:540px;margin:2em auto;background:#f7f5fc;padding:2em 2.5em;border-radius:18px;box-shadow:0 8px 24px #d6d1ec44;">
    <h2 class="titulo-pagina" style="margin-bottom:1.6em;"><i class="fa-solid fa-gear"></i> Configurações</h2>

    <!-- Formulário para agrupar as opções de configuração. -->
    <form class="config-form" style="display:flex;flex-direction:column;gap:2em;">

        <!-- Seção para configurar os discos a serem monitorados. -->
        <fieldset style="border:none;background:#ede9fe;padding:1em 1.5em;border-radius:12px;">
            <legend style="font-weight:700;color:#7c3aed;"><i class="fa-solid fa-hard-drive"></i> Discos monitorados
            </legend>
            <div style="font-size:0.96em;color:#574d86;margin-bottom:0.7em;">
                Selecione os discos que deverão aparecer no dashboard principal.
            </div>
            <!-- Este div será preenchido dinamicamente com os discos disponíveis via JavaScript. -->
            <div id="discos-config"></div>
        </fieldset>

        <!-- Seção para configurar o limite de alerta da CPU. -->
        <fieldset style="border:none;background:#ede9fe;padding:1em 1.5em;border-radius:12px;">
            <legend style="font-weight:700;color:#7c3aed;"><i class="fa-solid fa-triangle-exclamation"></i> Limite de
                alerta de CPU</legend>
            <label style="font-size:0.96em;color:#574d86;">Receba alertas quando o uso de CPU passar de:</label>
            <input type="number" id="cpuLimite" min="1" max="100" value="80"
                style="margin-top:0.5em;width:80px;padding:0.5em;border-radius:8px;border:1px solid #a78bfa;"> %
        </fieldset>

        <!-- Botão para salvar e área para exibir mensagem de confirmação. -->
        <div style="display:flex;align-items:center;gap:1em;">
            <button type="button" class="btn-roxo" style="height:44px;font-size:1.08em;" onclick="salvarConfig()">Salvar
                Configurações</button>
            <span id="msgConfig" class="msg-config" style="color:#7c3aed;font-weight:600;font-size:1.08em;"></span>
        </div>
    </form>
</div>

<script>
    /**
     * Ao carregar a página, este script busca a lista de discos do sistema
     * e preenche as opções de checkbox, marcando aquelas que já foram salvas
     * anteriormente no localStorage do navegador.
     */
    // 1. Busca os dados de métricas para obter a lista de todos os discos disponíveis.
    fetch('/metrics').then(r => r.json()).then(data => {
        // 2. Recupera a lista de discos que o usuário já marcou, salva no localStorage.
        // Se não houver nada salvo, usa um array vazio como padrão.
        let discosSelecionados = JSON.parse(localStorage.getItem('discosMonitorados') || '[]');
        const discosDiv = document.getElementById('discos-config');

        // 3. Itera sobre cada disco retornado pela API.
        Object.keys(data.discos).forEach(dev => {
            let id = 'disco-' + dev.replace(/[^\w]/g, '_'); // Cria um ID seguro para o HTML.

            // 4. Verifica se o disco deve ser marcado:
            // Se a lista de 'discosSelecionados' não estiver vazia, verifica se o disco atual está na lista.
            // Se a lista estiver vazia (primeiro acesso), marca todos os discos por padrão (checked = true).
            let checked = discosSelecionados.length ? discosSelecionados.includes(dev) : true;

            // 5. Adiciona o HTML do checkbox para o disco na página.
            discosDiv.innerHTML += `<label style="margin-right:1.1em;">
                <input type="checkbox" id="${id}" ${checked ? 'checked' : ''} data-disco="${dev}"> 
                <span style="color:#7c3aed;font-weight:600;">${dev}</span> 
                <span style="color:#a78bfa;">(${data.discos[dev].mountpoint})</span>
            </label>`;
        });
    });

    /**
     * Coleta os valores selecionados no formulário e os salva no localStorage do navegador.
     * O localStorage permite que as configurações persistam entre as visitas à página.
     */
    function salvarConfig() {
        // Salva os discos selecionados.
        let discosSelecionados = [];
        // Itera sobre todos os checkboxes de disco.
        document.querySelectorAll('#discos-config input[type=checkbox]').forEach((el) => {
            if (el.checked) {
                discosSelecionados.push(el.getAttribute('data-disco'));
            }
        });
        // Armazena a lista de discos selecionados como um texto JSON no localStorage.
        localStorage.setItem('discosMonitorados', JSON.stringify(discosSelecionados));

        // Salva o limite de alerta da CPU.
        let cpuLimite = document.getElementById('cpuLimite').value;
        localStorage.setItem('cpuLimite', cpuLimite);

        // Exibe uma mensagem de confirmação para o usuário.
        document.getElementById('msgConfig').innerText = "Configurações salvas!";
        showToastr("Configurações salvas!"); // Usa a função do base.html
        // Limpa a mensagem após 2 segundos.
        setTimeout(() => { document.getElementById('msgConfig').innerText = ""; }, 2000);
    }
</script>
{% endblock %}